# Story 1.4: Docker Compose Configuration for Deployment

## Status
Ready for Review

## Story

**As a** DevOps engineer,
**I want** a Docker Compose configuration that deploys the Rails app on a unique port,
**so that** the application can run on a shared VM without port conflicts.

## Acceptance Criteria

1. `Dockerfile` created with Ruby base image, Rails app installation, and production-ready configuration
2. `docker-compose.yml` configured to build and run Rails application container
3. Unique random port (e.g., 3847, 4921) defined in `docker-compose.yml` or `.env` file
4. `.env.example` file provided documenting required environment variables (PORT, SECRET_KEY_BASE, etc.)
5. Application accessible at `http://localhost:[UNIQUE_PORT]` when running `docker-compose up`
6. Dockerfile uses multi-stage build to minimize image size (optional but recommended)
7. Docker Compose configuration includes volume mounts for development convenience (optional for production)
8. README.md updated with Docker deployment instructions

## Tasks / Subtasks

- [x] Create Dockerfile (AC: 1, 6)
  - [x] Use Ruby 3.3-slim base image (Rails 8 generated)
  - [x] Set up multi-stage build (builder stage and production stage)
  - [x] Install dependencies (build-base, nodejs, npm for asset compilation)
  - [x] Copy application files and run bundle install
  - [x] Precompile assets in builder stage
  - [x] Create non-root user for security
  - [x] Set CMD to run Rails server (Thruster)
- [x] Create docker-compose.yml (AC: 2, 3, 5, 7)
  - [x] Define web service that builds from Dockerfile
  - [x] Map unique port (3847:80) - external:internal
  - [x] Reference PORT from environment variables
  - [x] Set environment variables (RAILS_ENV, SECRET_KEY_BASE from .env)
- [x] Create .env.example file (AC: 4)
  - [x] Document PORT variable
  - [x] Document SECRET_KEY_BASE variable
  - [x] Document RAILS_ENV variable
  - [x] Add instructions for creating actual .env file
- [x] Update README.md with deployment instructions (AC: 8)
  - [x] Document how to copy .env.example to .env
  - [x] Document how to generate SECRET_KEY_BASE
  - [x] Document docker-compose up command
  - [x] Document how to access application at unique port
- [x] Test Docker deployment (AC: 5)
  - [x] Run docker-compose up
  - [x] Verify application is accessible at configured port
  - [x] Test basic functionality (homepage loads)

## Dev Notes

### Docker Architecture (from architecture.md)
- **Multi-stage build**: Separate builder and production stages to minimize final image size
- **Base Image**: ruby:3.3-alpine (lightweight, production-ready)
- **Non-root user**: Create rails user for security best practices
- **Asset precompilation**: Compile assets in builder stage
- **Port Configuration**: Use unique random port to avoid conflicts on shared VM

### Dockerfile Reference
See `docs/architecture.md` for complete Dockerfile example with:
- Stage 1: Builder (installs deps, compiles assets)
- Stage 2: Production (minimal runtime image)
- Security: Non-root user (rails:rails)
- Expose: Port 3000 internally, mapped externally via docker-compose

### Environment Variables
```
PORT=3847  # Unique port for this app
SECRET_KEY_BASE=<generate with `rails secret`>
RAILS_ENV=production
```

### Unique Port Selection
Choose a random port between 3000-9999 that doesn't conflict with other services on the VM. Example: 3847, 4721, 5932

### Testing

**Test Requirements**:
- Docker image builds successfully
- docker-compose up starts application
- Application accessible at http://localhost:[PORT]
- Homepage renders correctly in containerized environment
- Assets (CSS/JS) load correctly

**Manual Testing**:
- Build: `docker-compose build`
- Run: `docker-compose up`
- Access: Open browser to `http://localhost:3847`
- Verify: Homepage loads with styles

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-30 | 0.1 | Initial story created from PRD | John (PM) |
| 2025-10-30 | 1.0 | Docker configuration complete, ready for testing | James (Dev) |
| 2025-10-30 | 1.1 | Docker deployment tested and verified successful | James (Dev) |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-5-20250929

### Debug Log References
- Issue: Docker container was trying to run `db:prepare` on startup but no database was configured
- Fix: Modified `bin/docker-entrypoint` to comment out database preparation step for static site
- Solution: Rebuilt image and restarted container successfully

### Completion Notes List
- Rails 8 automatically created production-ready Dockerfile during `rails new`
- Dockerfile uses ruby:3.3.8-slim base (not alpine, but slim variant for smaller size)
- Multi-stage build with three stages: base, build, final production
- Non-root user (rails:rails, UID 1000:1000) for security
- Asset precompilation happens in build stage with SECRET_KEY_BASE_DUMMY
- Thruster web server (Rails 8 default) runs on port 80 internally
- Created docker-compose.yml that maps external PORT (default 3847) to internal port 80
- Configurable via .env file for deployment flexibility on shared VMs
- Health check configured to use Rails /up endpoint
- Environment variables: RAILS_ENV, SECRET_KEY_BASE, RAILS_SERVE_STATIC_FILES, RAILS_LOG_TO_STDOUT
- restart policy: unless-stopped for automatic recovery
- Comprehensive README.md with Docker deployment instructions (260 lines)

### File List
**Already Existed:**
- Dockerfile - Generated by Rails 8 with multi-stage build (base → build → final)

**Created:**
- docker-compose.yml - Docker Compose configuration with configurable port
- .env.example - Environment variable template with documentation

**Modified:**
- README.md - Completely rewritten with comprehensive Docker deployment documentation
- bin/docker-entrypoint - Commented out database preparation for static site

**Testing Results:**
- ✅ Docker image builds successfully (multi-stage build completed)
- ✅ docker-compose up starts application without errors
- ✅ Application accessible at http://localhost:3847
- ✅ Health check endpoint (/up) returns HTTP 200 with green page
- ✅ Homepage renders correctly with header, footer, and TailwindCSS styles
- ✅ Container status: Up and healthy
- ✅ Port mapping: 0.0.0.0:3847->80/tcp working correctly
- ✅ Thruster proxy + Puma server running in production mode
- ✅ All assets (CSS/JS) loading correctly

## QA Results
_To be populated by QA agent_
