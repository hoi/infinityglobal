# Story 4.5: Security Hardening and Production Deployment

## Status
Draft

## Story

**As a** website owner,
**I want** the site secured and ready for public production deployment,
**so that** I can confidently launch without security vulnerabilities.

## Acceptance Criteria

1. HTTPS/SSL certificate configured (Let's Encrypt or VM-provided cert)
2. Rails security headers configured: HSTS, X-Frame-Options, X-Content-Type-Options, CSP
3. Environment variables properly secured (SECRET_KEY_BASE, any API keys in `.env`, not in git)
4. Production database config removed/disabled (confirm no DB credentials in codebase)
5. Docker Compose production configuration finalized (unique port, environment-specific settings)
6. Deployment documentation completed: VM setup instructions, Docker commands, environment variable setup
7. Application deployed to production VM and accessible via configured port
8. Manual smoke testing on production: all pages load, all links work, contact links function
9. Security scan run (basic vulnerability check, e.g., OWASP ZAP or similar)
10. Final QA checklist completed: all functional requirements (FR1-FR13) verified in production

## Tasks / Subtasks

- [ ] Configure HTTPS/SSL (AC: 1)
  - [ ] Obtain SSL certificate (Let's Encrypt or VM-provided)
  - [ ] Configure nginx or reverse proxy for HTTPS
  - [ ] Test HTTPS access
  - [ ] Redirect HTTP to HTTPS
- [ ] Configure Rails security headers (AC: 2)
  - [ ] Set HSTS header
  - [ ] Set X-Frame-Options header
  - [ ] Set X-Content-Type-Options header
  - [ ] Configure Content Security Policy (CSP)
- [ ] Secure environment variables (AC: 3)
  - [ ] Ensure .env is in .gitignore
  - [ ] Generate production SECRET_KEY_BASE
  - [ ] Document all required environment variables
  - [ ] Verify no secrets in git history
- [ ] Remove database config (AC: 4)
  - [ ] Remove or disable database.yml if not needed
  - [ ] Remove any DB gems if truly not using database
  - [ ] Verify no DB credentials in codebase
- [ ] Finalize Docker Compose config (AC: 5)
  - [ ] Set production environment variables
  - [ ] Configure unique port
  - [ ] Optimize for production (no dev volumes, etc.)
- [ ] Create deployment documentation (AC: 6)
  - [ ] Document VM setup steps
  - [ ] Document Docker deployment commands
  - [ ] Document environment variable configuration
  - [ ] Document how to update/redeploy
- [ ] Deploy to production VM (AC: 7)
  - [ ] SSH to VM
  - [ ] Clone repository
  - [ ] Set up .env file
  - [ ] Run docker-compose up -d
  - [ ] Verify application accessible
- [ ] Production smoke testing (AC: 8)
  - [ ] Test all pages load
  - [ ] Test all navigation links
  - [ ] Test tel: and mailto: links
  - [ ] Verify responsive design
- [ ] Run security scan (AC: 9)
  - [ ] Run basic vulnerability scan
  - [ ] Address any critical issues found
- [ ] Final QA checklist (AC: 10)
  - [ ] Verify all FR1-FR13 requirements in production
  - [ ] Complete comprehensive testing checklist

## Dev Notes

### Rails Security Headers
In `config/environments/production.rb`:
```ruby
config.force_ssl = true  # Force HTTPS
config.action_dispatch.default_headers = {
  'X-Frame-Options' => 'SAMEORIGIN',
  'X-Content-Type-Options' => 'nosniff',
  'X-XSS-Protection' => '1; mode=block',
  'Strict-Transport-Security' => 'max-age=31536000; includeSubDomains'
}
```

### Environment Variables
Required in .env:
```
PORT=3847
SECRET_KEY_BASE=<generate with `rails secret`>
RAILS_ENV=production
RAILS_SERVE_STATIC_FILES=true
```

### Docker Compose Production
```yaml
version: '3.8'
services:
  web:
    build: .
    ports:
      - "${PORT}:3000"
    environment:
      - RAILS_ENV=production
      - SECRET_KEY_BASE=${SECRET_KEY_BASE}
    restart: unless-stopped
```

### Deployment Commands
```bash
# On VM
git clone <repo>
cd infinityglobal
cp .env.example .env
# Edit .env with production values
docker-compose build
docker-compose up -d
```

### Security Scan Tools
- OWASP ZAP (free, open-source)
- Mozilla Observatory
- SecurityHeaders.com
- SSL Labs SSL Test

### Functional Requirements Checklist (FR1-FR13)
- FR1: Header with nav links ✓
- FR2: Header CTA button ✓
- FR3: Homepage hero with CTA ✓
- FR4: About page with credentials ✓
- FR5: About page with methodology ✓
- FR6: Contact page with links ✓
- FR7: Contact page with address ✓
- FR8: Terms of Service page ✓
- FR9: Privacy Policy page ✓
- FR10: Logo integration ✓
- FR11: Stock photography ✓
- FR12: Footer with info and links ✓
- FR13: Consistent header/footer ✓

### Testing

**Test Requirements**:
- HTTPS works and HTTP redirects to HTTPS
- Security headers are set correctly
- Environment variables are secure
- Application deploys successfully
- All pages work in production
- All links function correctly
- Security scan shows no critical issues
- All functional requirements verified

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-30 | 0.1 | Initial story created from PRD | John (PM) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
